<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Executivo (v12.8 - L√≥gica de Neg√≥cio Final)</title>

  <!-- Bibliotecas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

  <style>
    :root {
      --primary-color: #667eea;
      --primary-dark: #5a68d0;
      --export-color: #15803d;
      --export-dark: #166534;
      --bg-light: #f5f5f5;
      --bg-card: #ffffff;
      --text-dark: #333;
      --text-light: #777;
      --status-excellent-bg: #f0fdf4;
      --status-excellent-text: #15803d;
      --status-good-bg: #fefce8;
      --status-good-text: #a16207;
      --status-critical-bg: #fef2f2;
      --status-critical-text: #b91c1c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      padding: 20px;
      color: var(--text-dark);
    }

    .container {
      max-width: 1900px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 24px 30px;
    }

    .header h1 { font-size: 26px; margin-bottom: 6px; }
    .header p { font-size: 14px; opacity: 0.9; }

    .content { padding: 20px 24px 28px; }

    .advanced-filters {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
    }

    .filters-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-dark);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: end;
    }

    .filter-group { display: flex; flex-direction: column; gap: 6px; }
    .filter-group label { font-size: 12px; font-weight: 600; color: var(--text-light); }

    select, input[type="file"], input[type="search"] {
      padding: 8px 12px; font-size: 13px; border-radius: 6px; border: 1px solid #d1d5db; background: #fff;
    }

    button {
      padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer;
      background: var(--primary-color); color: #fff; font-weight: 600;
    }
    .export-btn { background: var(--export-color); }
    .export-btn:hover:not(:disabled) { background: var(--export-dark); }

    button:disabled, select:disabled, input:disabled {
      background-color: #e5e7eb; cursor: not-allowed; opacity: 0.6;
    }

    .kpi-section { margin-bottom: 24px; }
    .kpi-section-title {
      font-size: 16px; font-weight: 700; color: var(--text-dark);
      margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-color);
    }
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .kpi-card {
      background: var(--bg-card); border-radius: 10px; padding: 16px;
      border: 1px solid #e5e7eb; display: flex; flex-direction: column;
    }
    .kpi-label { font-size: 13px; color: var(--text-light); font-weight: 600; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
    .kpi-extra { font-size: 12px; color: #999; margin-top: auto; }

    .performance-tables-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }
    .performance-table-card {
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 12px; padding: 16px 20px;
    }
    .performance-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .performance-table-title {
      font-size: 14px; font-weight: 600; color: #333;
    }
    .search-bar-container { margin-bottom: 12px; }
    .search-bar-container input { width: 100%; }
    .performance-table-container {
      max-height: 400px; overflow-y: auto;
      border: 1px solid #e5e7eb; border-radius: 8px;
    }
    .performance-table { width: 100%; border-collapse: collapse; }
    .performance-table thead { position: sticky; top: 0; background: #f9fafb; z-index: 1; }
    .performance-table th {
      padding: 10px 12px; text-align: left; font-size: 11px;
      font-weight: 600; color: #6b7280; text-transform: uppercase;
      border-bottom: 1px solid #e5e7eb;
    }
    .performance-table td {
      padding: 8px 12px; font-size: 13px; border-bottom: 1px solid #f3f4f6;
    }

    #supervisorTableContainer .performance-table tr { cursor: pointer; transition: background-color 0.2s; }
    #supervisorTableContainer .performance-table tr:hover { background-color: #f3f4f6; }
    #supervisorTableContainer .performance-table tr.selected-row {
      background-color: var(--primary-color) !important; color: #fff;
    }
    #supervisorTableContainer .performance-table tr.selected-row .td-rank,
    #supervisorTableContainer .performance-table tr.selected-row .td-name,
    #supervisorTableContainer .performance-table tr.selected-row .td-perc {
      color: #fff; font-weight: 700;
    }

    .performance-table-card .excellent { background-color: var(--status-excellent-bg); }
    .performance-table-card .good { background-color: var(--status-good-bg); }
    .performance-table-card .critical { background-color: var(--status-critical-bg); }

    .performance-bar-container {
      width: 100%; background-color: #e5e7eb; border-radius: 4px;
      height: 8px;
    }
    .performance-bar { height: 100%; }

    .excellent .performance-bar { background-color: var(--status-excellent-text); }
    .good .performance-bar { background-color: var(--status-good-text); }
    .critical .performance-bar { background-color: var(--status-critical-text); }

    .td-rank { font-weight: 600; color: var(--text-light); }
    .td-name { font-weight: 500; }
    .td-perc {
      font-weight: 700;
      font-size: 12px;
      width: 60px;
      text-align: right;
    }
    .td-perc.excellent { color: var(--status-excellent-text); }
    .td-perc.good { color: var(--status-good-text); }
    .td-perc.critical { color: var(--status-critical-text); }

    .summary-tables-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px; margin-bottom: 24px;
    }
    .summary-table-card {
      background: #fff; border-radius: 12px;
      padding: 16px 20px; border: 1px solid #e5e7eb;
    }
    .summary-table-title {
      font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px;
    }

    @media (max-width: 1200px) {
      .performance-tables-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 900px) {
      .summary-tables-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .header { flex-direction: column; align-items: flex-start; }
      .filters-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Programa Mais Sa√∫de Com Agente ‚Äì Monitoramento de Lan√ßamento de Notas v2.8</h1>
      <p>An√°lise com nomenclatura de turma (MACE/MACS) e l√≥gica de neg√≥cio final.</p>
    </header>

    <main class="content">
      <section class="advanced-filters">
        <div class="filters-title">üîç Filtros e Controles</div>
        <div class="filters-grid">
          <div class="filter-group">
            <label for="csvFileInput">Carregar Arquivo CSV</label>
            <input type="file" id="csvFileInput" accept=".csv" />
          </div>
          <div class="filter-group">
            <label for="filtroTurma">Tipo de Turma</label>
            <select id="filtroTurma" disabled><option value="">Todas</option></select>
          </div>
          <div class="filter-group">
            <label for="filtroDisciplina">Disciplina</label>
            <select id="filtroDisciplina" disabled><option value="">Todas</option></select>
          </div>
          <div class="filter-group">
            <label for="filtroSupervisor">Supervisor</label>
            <select id="filtroSupervisor" disabled><option value="">Todos</option></select>
          </div>
          <div class="filter-group">
            <label for="filtroPreceptor">Preceptor</label>
            <select id="filtroPreceptor" disabled><option value="">Todos</option></select>
          </div>
          <div class="filter-group">
            <label for="filtroRegiao">Regi√£o</label>
            <select id="filtroRegiao" disabled><option value="">Todas</option></select>
          </div>
          <div class="filter-group">
            <label for="filtroPerformance">Filtrar por Performance</label>
            <select id="filtroPerformance" disabled>
              <option value="">Todas</option>
              <option value="critical">Cr√≠ticos (&lt; 80%)</option>
              <option value="good">Bons (80‚Äì99%)</option>
              <option value="excellent">Completos (100%)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button id="btnLimparFiltros" disabled>Limpar Filtros</button>
          </div>
          <div class="filter-group">
            <label>Limpar Cache de An√°lise</label>
            <button id="btnLimparCache" disabled>Limpar Cache</button>
          </div>
          <div class="filter-group">
            <label>Exportar Dados</label>
            <button id="btnExportSupervisoresCSV" class="export-btn" disabled>Supervisores (CSV)</button>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button id="btnExportPreceptoresCSV" class="export-btn" disabled>Preceptores (CSV)</button>
          </div>
        </div>
      </section>

      <section class="kpi-section">
        <h3 class="kpi-section-title">Vis√£o Geral</h3>
        <div class="kpis">
          <div class="kpi-card">
            <div class="kpi-label">Performance Geral</div>
            <div class="kpi-value" id="kpiPercentualGeral">0%</div>
            <div class="kpi-extra" id="kpiAlunos">0 registros</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Registros Pendentes</div>
            <div class="kpi-value" id="kpiPendentes">0</div>
            <div class="kpi-extra" id="kpiPendentesPercent">0% do total</div>
          </div>
        </div>
      </section>

      <div class="performance-tables-grid">
        <div class="performance-table-card">
          <h4 class="performance-table-title">Performance por Supervisor</h4>
          <div class="search-bar-container">
            <input type="search" id="searchSupervisor" placeholder="Buscar supervisor..." disabled>
          </div>
          <div id="supervisorTableContainer" class="performance-table-container"></div>
        </div>
        <div class="performance-table-card">
          <div class="performance-table-header">
            <h4 class="performance-table-title" id="preceptorTableTitle">Preceptores</h4>
          </div>
          <div class="search-bar-container">
            <input type="search" id="searchPreceptor" placeholder="Buscar preceptor..." disabled>
          </div>
          <div id="preceptorTableContainer" class="performance-table-container">
            <p style="text-align:center; color:#999; padding: 20px;">Selecione um supervisor para ver seus preceptores.</p>
          </div>
        </div>
      </div>

      <div class="summary-tables-grid">
        <div class="summary-table-card">
          <h4 class="summary-table-title">Resumo Geral</h4>
          <div id="resumoGeralTableContainer"></div>
        </div>
        <div class="summary-table-card">
          <h4 class="summary-table-title">Compara√ß√£o ACE vs ACS</h4>
          <div id="aceAcsTableContainer"></div>
        </div>
        <div class="summary-table-card">
          <h4 class="summary-table-title">Performance M√©dia: Supervisores vs Preceptores</h4>
          <div id="compGeralChartContainer" style="height: 150px;">
            <canvas id="compGeralChart"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const VALOR_PENDENTE = 'sem nota';

  let dados = [];
  let debounceTimer;
  let supervisorData = [];
  let preceptorData = [];
  let selectedSupervisor = null;
  let charts = { compGeral: null };
  let disciplineNamesForFilter = [];
  let currentAggregatedData = { total: 0, lancados: 0, porSupervisor: {}, porPreceptor: {}, porTurmaTipo: {}, porRegiao: {}, preceptorSupervisorLink: {} };

  class IntelligentCache {
    constructor(maxSize = 50) {
      this.cache = new Map();
      this.maxSize = maxSize;
    }
    generateKey(filters = {}) { return Object.keys(filters).sort().map(key => `${key}:${filters[key]}`).join('|'); }
    get(key) { return this.cache.has(key) ? this.cache.get(key) : null; }
    set(key, value) {
      if (this.cache.size >= this.maxSize) { this.cache.delete(this.cache.keys().next().value); }
      this.cache.set(key, value);
    }
    clear() { this.cache.clear(); }
  }

  const cache = new IntelligentCache(100);

  const selectors = {
    csvInput: document.getElementById('csvFileInput'),
    turma: document.getElementById('filtroTurma'),
    disciplina: document.getElementById('filtroDisciplina'),
    supervisor: document.getElementById('filtroSupervisor'),
    preceptor: document.getElementById('filtroPreceptor'),
    regiao: document.getElementById('filtroRegiao'),
    performance: document.getElementById('filtroPerformance'),
    searchSupervisor: document.getElementById('searchSupervisor'),
    searchPreceptor: document.getElementById('searchPreceptor'),
    btnLimpar: document.getElementById('btnLimparFiltros'),
    btnLimparCache: document.getElementById('btnLimparCache'),
    btnExportSupervisores: document.getElementById('btnExportSupervisoresCSV'),
    btnExportPreceptores: document.getElementById('btnExportPreceptoresCSV')
  };

  const ui = {
    kpiPercentualGeral: document.getElementById('kpiPercentualGeral'),
    kpiAlunos: document.getElementById('kpiAlunos'),
    kpiPendentes: document.getElementById('kpiPendentes'),
    kpiPendentesPercent: document.getElementById('kpiPendentesPercent'),
    supervisorTableContainer: document.getElementById('supervisorTableContainer'),
    preceptorTableContainer: document.getElementById('preceptorTableContainer'),
    preceptorTableTitle: document.getElementById('preceptorTableTitle'),
    resumoGeralTableContainer: document.getElementById('resumoGeralTableContainer'),
    aceAcsTableContainer: document.getElementById('aceAcsTableContainer'),
    compGeralChart: document.getElementById('compGeralChart')
  };

  function debounce(fn, delay) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fn, delay);
  }

  function setFiltrosHabilitados(enabled) {
    const toToggle = [ selectors.turma, selectors.disciplina, selectors.supervisor, selectors.preceptor, selectors.regiao, selectors.performance, selectors.searchSupervisor, selectors.searchPreceptor, selectors.btnLimpar, selectors.btnLimparCache, selectors.btnExportSupervisores, selectors.btnExportPreceptores ];
    toToggle.forEach(el => { if (el) el.disabled = !enabled; });
    selectors.csvInput.disabled = false;
  }

  function ehLancado(rec) {
    const v = String(rec.nota ?? '').trim().toLowerCase();
    return v && v !== VALOR_PENDENTE && v !== 'apr' && v !== '0' && v !== '0.0000';
  }
  
  // ============== IN√çCIO DA L√ìGICA DE TRANSFORMA√á√ÉO FINAL ==============
  function transformarDados(rows) {
      if (!rows || rows.length < 3) {
          throw new Error("O arquivo CSV precisa ter pelo menos 3 linhas (2 de cabe√ßalho e 1 de dados).");
      }

      const disciplineNamesHeader = (rows[0] || []).map(h => String(h || '').trim().toUpperCase());
      const mainHeader = (rows[1] || []).map(h => String(h || '').trim().toUpperCase());
      const dataRows = rows.slice(2);
      
      const getColumnIndex = (header, potentialNames) => {
          for (const name of potentialNames) {
              const index = header.indexOf(name.toUpperCase());
              if (index !== -1) return index;
          }
          return -1;
      };

      const colIdx = {
          supervisor: getColumnIndex(mainHeader, ['SUPERVISOR', 'NOME SUPERVISOR']),
          preceptor: getColumnIndex(mainHeader, ['PRECEPTOR', 'NOME PRECEPTOR']),
          turma: getColumnIndex(mainHeader, ['GRUPO', 'TURMA']),
          aluno: getColumnIndex(mainHeader, ['CURSISTA', 'ALUNO', 'NOME ALUNO']),
          uf: getColumnIndex(mainHeader, ['UF', 'ESTADO'])
      };
      
      const missingColumns = ['aluno', 'turma', 'supervisor', 'preceptor'].filter(key => colIdx[key] === -1);
      if (missingColumns.length > 0) {
          throw new Error(`Na linha 2 do arquivo, n√£o foi poss√≠vel encontrar as colunas: ${missingColumns.join(', ')}.\n\nCabe√ßalhos encontrados na Linha 2: ${mainHeader.join(', ')}`);
      }
      
      const disciplineMap = {};
      const processedIndexes = new Set(Object.values(colIdx).filter(i => i !== -1));
      disciplineNamesForFilter = [];

      for (let i = 0; i < disciplineNamesHeader.length; i++) {
          if (processedIndexes.has(i)) continue;

          const discName = disciplineNamesHeader[i];
          if (!discName) continue;

          if (i + 1 < disciplineNamesHeader.length && disciplineNamesHeader[i+1] === discName) {
              disciplineMap[discName] = { ACS: i, ACE: i + 1 };
              processedIndexes.add(i);
              processedIndexes.add(i + 1);
          } else {
              disciplineMap[discName] = { common: i };
              processedIndexes.add(i);
          }
          if(!disciplineNamesForFilter.includes(discName)) {
            disciplineNamesForFilter.push(discName);
          }
      }
      
      if (Object.keys(disciplineMap).length === 0) {
          alert("Aviso: Nenhuma coluna de disciplina foi identificada. Verifique as linhas 1 e 2 do seu arquivo.");
      }

      const dadosLongos = [];
      let supervisorAtual = 'N/A';
      let preceptorAtual = 'N/A';

      for (const row of dataRows) {
          try {
              if (row.every(cell => !cell || cell.trim() === '')) continue;

              const nomeAluno = (row[colIdx.aluno] || '').trim();
              if (!nomeAluno) continue;

              const supervisorDaLinha = (row[colIdx.supervisor] || '').trim();
              if (supervisorDaLinha) supervisorAtual = supervisorDaLinha;
              
              const preceptorDaLinha = (row[colIdx.preceptor] || '').trim();
              if (preceptorDaLinha) preceptorAtual = preceptorDaLinha;

              const turmaOriginal = (row[colIdx.turma] || '').trim();
              if (!turmaOriginal) continue;

              const uf = colIdx.uf !== -1 ? (row[colIdx.uf] || 'N/A').trim() : 'N/A';
              
              // *** LINHA CORRIGIDA ***
              const turmaTipo = turmaOriginal.toUpperCase().includes('MACE') ? 'ACE' : 'ACS';
              
              let regiao = 'MT (Outros)';
              if (uf.toUpperCase() === 'RO') regiao = 'Rond√¥nia';
              else if (uf.toUpperCase() === 'PR') regiao = 'Paran√°';

              const base = { supervisor: supervisorAtual, preceptor: preceptorAtual, turma: turmaOriginal, turmaTipo, aluno: nomeAluno, regiao };

              for (const discName in disciplineMap) {
                  const mapping = disciplineMap[discName];
                  let colIndex = -1;

                  if (mapping.common !== undefined) {
                      colIndex = mapping.common;
                  } else {
                      colIndex = mapping[turmaTipo];
                  }

                  const nota = (colIndex !== undefined && colIndex < row.length) ? (row[colIndex] || '').trim() || VALOR_PENDENTE : VALOR_PENDENTE;
                  dadosLongos.push({ ...base, disciplina: discName, nota });
              }
          } catch (e) {
              console.warn(`Erro ao processar linha de dados:`, e, row);
          }
      }
      return dadosLongos;
  }
  // ============== FIM DA L√ìGICA DE TRANSFORMA√á√ÉO FINAL ==============


  function generateFilterKey() {
    const filters = { turma: selectors.turma.value || '', disciplina: selectors.disciplina.value || '', supervisor: selectors.supervisor.value || '', preceptor: selectors.preceptor.value || '', regiao: selectors.regiao.value || '', performance: selectors.performance.value || '' };
    return cache.generateKey(filters);
  }

  function filtrarDados() {
    const key = `filter_${generateFilterKey()}`;
    const cached = cache.get(key);
    if (cached) return cached;
    const f = { turma: selectors.turma.value, disciplina: selectors.disciplina.value, supervisor: selectors.supervisor.value, preceptor: selectors.preceptor.value, regiao: selectors.regiao.value };
    let result = dados;
    if (f.turma) result = result.filter(d => d.turmaTipo === f.turma);
    if (f.disciplina) result = result.filter(d => d.disciplina === f.disciplina);
    if (f.supervisor) result = result.filter(d => d.supervisor === f.supervisor);
    if (f.preceptor) result = result.filter(d => d.preceptor === f.preceptor);
    if (f.regiao) result = result.filter(d => d.regiao === f.regiao);
    cache.set(key, result);
    return result;
  }

  function calcularAgregados(registros) {
    const key = `agg_${generateFilterKey()}_${registros.length}`;
    const cached = cache.get(key);
    if (cached) return cached;
    const ag = { total: registros.length, lancados: 0, porSupervisor: {}, porPreceptor: {}, porTurmaTipo: {}, porRegiao: {}, preceptorSupervisorLink: {} };
    registros.forEach(r => {
      const lanc = ehLancado(r);
      if (lanc) ag.lancados++;
      const supervisor = r.supervisor || 'N/A', preceptor = r.preceptor || 'N/A', turmaTipo = r.turmaTipo || 'N/A', regiao = r.regiao || 'N/A';
      ['supervisor', 'preceptor', 'turmaTipo', 'regiao'].forEach(key => {
        const nome = r[key] || 'N/A';
        if (nome === 'N/A' || nome.trim() === '') return;
        const mapKey = `por${key.charAt(0).toUpperCase() + key.slice(1)}`;
        if (!ag[mapKey][nome]) ag[mapKey][nome] = { total: 0, lancados: 0 };
        ag[mapKey][nome].total++;
        if (lanc) ag[mapKey][nome].lancados++;
      });
      if (preceptor !== 'N/A' && supervisor !== 'N/A' && preceptor.trim() !== '' && supervisor.trim() !== '') {
        if (!ag.preceptorSupervisorLink[preceptor]) ag.preceptorSupervisorLink[preceptor] = {};
        if (!ag.preceptorSupervisorLink[preceptor][supervisor]) ag.preceptorSupervisorLink[preceptor][supervisor] = 0;
        ag.preceptorSupervisorLink[preceptor][supervisor]++;
      }
    });
    Object.keys(ag.preceptorSupervisorLink).forEach(preceptor => {
      const supervisors = ag.preceptorSupervisorLink[preceptor];
      ag.preceptorSupervisorLink[preceptor] = Object.keys(supervisors).reduce((a, b) => supervisors[a] > supervisors[b] ? a : b);
    });
    cache.set(key, ag);
    return ag;
  }

  function criarOuAtualizarChart(instance, ctx, type, data, options) {
    if (instance) {
      instance.data = data;
      instance.options = options;
      instance.update();
      return instance;
    }
    return new Chart(ctx, { type, data, options });
  }

  function updateAllUI() {
    const { total, lancados } = currentAggregatedData;
    const percLancados = total > 0 ? (lancados / total) * 100 : 0;
    const pendentes = total - lancados;
    const percPendentes = total > 0 ? (pendentes / total) * 100 : 0;
    ui.kpiPercentualGeral.textContent = `${percLancados.toFixed(1)}%`;
    ui.kpiAlunos.textContent = `${total.toLocaleString('pt-BR')} registros`;
    ui.kpiPendentes.textContent = pendentes.toLocaleString('pt-BR');
    ui.kpiPendentesPercent.textContent = `${percPendentes.toFixed(1)}% do total`;
    prepareAndRenderTables(currentAggregatedData);
    updateSummaryTables(currentAggregatedData);
  }

  function prepareAndRenderTables(ag) {
    supervisorData = Object.entries(ag.porSupervisor).filter(([name]) => name !== 'N/A').map(([name, { total, lancados }]) => ({ name, total, lancados, perc: total > 0 ? (lancados / total) * 100 : 0 })).sort((a, b) => b.perc - a.perc);
    preceptorData = Object.entries(ag.porPreceptor).filter(([name]) => name !== 'N/A').map(([name, { total, lancados }]) => ({ name, total, lancados, perc: total > 0 ? (lancados / total) * 100 : 0, supervisor: ag.preceptorSupervisorLink[name] || 'N/A' })).sort((a, b) => b.perc - a.perc);
    renderSupervisorTable();
    if (selectedSupervisor) { renderPreceptorTable(); } 
    else {
      ui.preceptorTableContainer.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Selecione um supervisor para ver seus preceptores.</p>';
      ui.preceptorTableTitle.textContent = 'Preceptores';
    }
  }

  function renderSupervisorTable() {
    let dataToRender = supervisorData.slice();
    const performanceFilter = selectors.performance.value;
    if (performanceFilter) { dataToRender = dataToRender.filter(d => { if (performanceFilter === 'critical') return d.perc < 80; if (performanceFilter === 'good') return d.perc >= 80 && d.perc < 100; if (performanceFilter === 'excellent') return d.perc >= 99.9; return true; }); }
    const searchTerm = selectors.searchSupervisor.value.toLowerCase().trim();
    if (searchTerm) { dataToRender = dataToRender.filter(d => d.name.toLowerCase().includes(searchTerm)); }
    ui.supervisorTableContainer.innerHTML = generatePerformanceTableHTML(dataToRender, 'supervisor');
    ui.supervisorTableContainer.querySelectorAll('tr[data-supervisor-name]').forEach(tr => {
      tr.addEventListener('click', handleSupervisorSelection);
      if (tr.dataset.supervisorName === selectedSupervisor) tr.classList.add('selected-row');
    });
  }

  function renderPreceptorTable() {
    if (!selectedSupervisor) return;
    let filteredPreceptors = preceptorData.filter(p => p.supervisor === selectedSupervisor);
    const performanceFilter = selectors.performance.value;
    if (performanceFilter) { filteredPreceptors = filteredPreceptors.filter(d => { if (performanceFilter === 'critical') return d.perc < 80; if (performanceFilter === 'good') return d.perc >= 80 && d.perc < 100; if (performanceFilter === 'excellent') return d.perc >= 99.9; return true; });}
    const searchTerm = selectors.searchPreceptor.value.toLowerCase().trim();
    if (searchTerm) { filteredPreceptors = filteredPreceptors.filter(d => d.name.toLowerCase().includes(searchTerm)); }
    ui.preceptorTableContainer.innerHTML = generatePerformanceTableHTML(filteredPreceptors, 'preceptor');
    ui.preceptorTableTitle.textContent = `Preceptores de ${selectedSupervisor}`;
  }

  function handleSupervisorSelection(e) {
    const row = e.target.closest('tr');
    if (!row) return;
    const supervisorName = row.dataset.supervisorName;
    if (selectedSupervisor === supervisorName) {
      selectedSupervisor = null;
      row.classList.remove('selected-row');
      ui.preceptorTableContainer.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Selecione um supervisor para ver seus preceptores.</p>';
      ui.preceptorTableTitle.textContent = 'Preceptores';
    } else {
      selectedSupervisor = supervisorName;
      ui.supervisorTableContainer.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
      row.classList.add('selected-row');
      renderPreceptorTable();
    }
  }

  function generatePerformanceTableHTML(data, type) {
    if (!data || data.length === 0) return `<p style="text-align:center; color:#999; padding: 20px;">Nenhum ${type} para exibir com os filtros atuais.</p>`;
    const headers = [ { key: 'rank', label: '#' }, { key: 'name', label: 'Nome' }, { key: 'lancados', label: 'Lan√ßamentos' }, { key: 'perc', label: '%' }, { key: 'perc_bar', label: 'Performance' } ];
    let headerHTML = '<thead><tr>' + headers.map(h => `<th>${h.label}</th>`).join('') + '</tr></thead>';
    let bodyHTML = '<tbody>';
    data.forEach((item, index) => {
      const perc = item.perc;
      let statusClass = 'critical';
      if (perc >= 99.9) statusClass = 'excellent'; else if (perc >= 80) statusClass = 'good';
      const supervisorAttr = type === 'supervisor' ? `data-supervisor-name="${item.name}"` : '';
      bodyHTML += `<tr class="${statusClass}" ${supervisorAttr}> <td class="td-rank">${index + 1}</td> <td class="td-name">${item.name}</td> <td>${item.lancados}/${item.total}</td> <td class="td-perc ${statusClass}">${perc.toFixed(1)}%</td> <td> <div class="performance-bar-container"> <div class="performance-bar" style="width: ${Math.min(perc, 100)}%;"></div> </div> </td> </tr>`;
    });
    bodyHTML += '</tbody>';
    return `<table class="performance-table">${headerHTML}${bodyHTML}</table>`;
  }

  function updateSummaryTables(ag) {
    const { lancados, total } = ag;
    const percLancados = total > 0 ? (lancados / total) * 100 : 0;
    const pendentes = total - lancados;
    let resumoHTML = '<table class="performance-table"><tbody>';
    resumoHTML += `<tr class="excellent"><td class="td-name">Lan√ßados</td><td>${lancados.toLocaleString('pt-BR')}</td><td class="td-perc excellent">${percLancados.toFixed(1)}%</td><td><div class="performance-bar-container"><div class="performance-bar" style="width: ${percLancados}%;"></div></div></td></tr>`;
    resumoHTML += `<tr class="critical"><td class="td-name">Pendentes</td><td>${pendentes.toLocaleString('pt-BR')}</td><td class="td-perc critical">${(total > 0 ? (pendentes / total) * 100 : 0).toFixed(1)}%</td><td><div class="performance-bar-container"><div class="performance-bar" style="width: ${(total > 0 ? (pendentes / total) * 100 : 0)}%;"></div></div></td></tr>`;
    ui.resumoGeralTableContainer.innerHTML = resumoHTML + '</tbody></table>';

    const turmaData = Object.entries(ag.porTurmaTipo).filter(([name]) => name !== 'N/A').map(([name, { total, lancados }]) => ({ name, total, lancados, perc: total > 0 ? (lancados / total) * 100 : 0 })).sort((a, b) => b.perc - a.perc);
    let aceAcsHTML = '<table class="performance-table"><tbody>';
    if (turmaData.length > 0) {
      turmaData.forEach(item => {
        let statusClass = 'critical'; if (item.perc >= 99.9) statusClass = 'excellent'; else if (item.perc >= 80) statusClass = 'good';
        aceAcsHTML += `<tr class="${statusClass}"><td class="td-name">${item.name}</td><td>${item.lancados}/${item.total}</td><td class="td-perc ${statusClass}">${item.perc.toFixed(1)}%</td><td><div class="performance-bar-container"><div class="performance-bar" style="width: ${item.perc}%;"></div></div></td></tr>`;
      });
    } else { aceAcsHTML += '<tr><td colspan="4" style="text-align:center; color:#999;">Nenhum dado de turma para exibir.</td></tr>'; }
    ui.aceAcsTableContainer.innerHTML = aceAcsHTML + '</tbody></table>';

    const supPerc = (supervisorData.reduce((acc, cur) => acc + cur.lancados, 0) / supervisorData.reduce((acc, cur) => acc + cur.total, 0)) * 100 || 0;
    const precPerc = (preceptorData.reduce((acc, cur) => acc + cur.lancados, 0) / preceptorData.reduce((acc, cur) => acc + cur.total, 0)) * 100 || 0;
    const chartData = { labels: ['Supervisores', 'Preceptores'], datasets: [{ label: '% Lan√ßamento M√©dio', data: [supPerc, precPerc], backgroundColor: ['rgba(102, 126, 234, 0.7)', 'rgba(21, 128, 61, 0.7)'], borderWidth: 1 }] };
    const chartOptions = { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed.x.toFixed(1)}%` } } } };
    charts.compGeral = criarOuAtualizarChart(charts.compGeral, ui.compGeralChart.getContext('2d'), 'bar', chartData, chartOptions);
  }

  function popularFiltros() {
    ['turma', 'disciplina', 'supervisor', 'preceptor', 'regiao'].forEach(tipo => {
      const selectEl = selectors[tipo];
      if (!selectEl) return;
      const placeholder = (tipo === 'regiao' || tipo === 'turma') ? 'Todas' : 'Todos';
      selectEl.innerHTML = `<option value="">${tipo === 'disciplina' ? 'Todas' : placeholder}</option>`;
      
      let lista;
      if (tipo === 'disciplina') {
        lista = disciplineNamesForFilter.sort((a,b) => a.localeCompare(b));
      } else {
        const key = tipo === 'turma' ? 'turmaTipo' : tipo;
        lista = [...new Set(dados.map(d => d[key]))].filter(item => item && item !== 'N/A' && item.trim() !== '').sort((a, b) => a.localeCompare(b));
      }

      lista.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectEl.appendChild(opt);
      });
    });
  }

  function runFullUpdate() {
    if (!dados || dados.length === 0) {
      setFiltrosHabilitados(false);
      ui.supervisorTableContainer.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Carregue um arquivo CSV para iniciar a an√°lise.</p>';
      return;
    }
    const baseFilteredData = filtrarDados();
    currentAggregatedData = calcularAgregados(baseFilteredData);
    updateAllUI();
    setFiltrosHabilitados(true);
  }

  function exportToCSV(data, filename) {
    if (!data || data.length === 0) { alert('N√£o h√° dados para exportar com os filtros atuais.'); return; }
    const dataToExport = data.map(({ name, total, lancados, perc, supervisor }) => ({ Nome: name, Lancamentos_Feitos: lancados, Total_de_Registros: total, 'Performance (%)': perc.toFixed(2), ...(supervisor ? { Supervisor_Associado: supervisor } : {}) }));
    const headers = Object.keys(dataToExport[0]);
    const csvRows = [headers.join(',')];
    for (const row of dataToExport) {
      const values = headers.map(header => { let value = row[header]; if (typeof value === 'string' && value.includes(',')) { value = '"' + value.replace(/"/g, '""') + '"'; } return value; });
      csvRows.push(values.join(','));
    }
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', filename);
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  function processFile(file) {
      if (!file) return;
      setFiltrosHabilitados(false);
      ui.supervisorTableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Processando arquivo... Isso pode levar um momento.</p>';
      ui.preceptorTableContainer.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Carregando dados...</p>';
      Papa.parse(file, {
          skipEmptyLines: true,
          complete: function(results) {
              if (results.errors.length > 0) { console.error('Erros PapaParse:', results.errors); alert('Erro ao processar CSV. Verifique o formato do arquivo. Detalhes no console (F12).'); setFiltrosHabilitados(false); return; }
              try {
                  const transformed = transformarDados(results.data);
                  if (!transformed || transformed.length === 0) { throw new Error('Nenhum dado v√°lido foi extra√≠do.'); }
                  dados = transformed;
                  cache.clear(); selectedSupervisor = null;
                  popularFiltros(); runFullUpdate();
              } catch (err) { console.error('Erro na transforma√ß√£o de dados:', err); alert('Falha ao processar os dados do arquivo: ' + err.message); setFiltrosHabilitados(false); }
          },
          error: function(error) { console.error('Erro fatal do PapaParse:', error); alert('Erro fatal ao ler o arquivo CSV. Verifique a integridade do arquivo.'); setFiltrosHabilitados(false); }
      });
  }

  selectors.csvInput.addEventListener('change', (e) => processFile(e.target.files[0]));
  ['turma', 'disciplina', 'supervisor', 'preceptor', 'regiao', 'performance'].forEach(key => { if (selectors[key]) { selectors[key].addEventListener('change', () => debounce(runFullUpdate, 300)); } });
  selectors.searchSupervisor.addEventListener('input', () => debounce(renderSupervisorTable, 250));
  selectors.searchPreceptor.addEventListener('input', () => debounce(renderPreceptorTable, 250));
  selectors.btnLimpar.addEventListener('click', () => {
    ['turma', 'disciplina', 'supervisor', 'preceptor', 'regiao', 'performance'].forEach(key => { if (selectors[key]) selectors[key].value = ''; });
    selectors.searchSupervisor.value = ''; selectors.searchPreceptor.value = '';
    selectedSupervisor = null; cache.clear(); debounce(runFullUpdate, 0);
  });
  selectors.btnLimparCache.addEventListener('click', () => { cache.clear(); alert('O cache de an√°lise (filtros) foi limpo com sucesso.'); });
  
  function getFilteredExportData(dataType) {
      let dataToExport = dataType === 'supervisor' ? supervisorData.slice() : preceptorData.slice();
      if (dataType === 'preceptor' && selectedSupervisor) {
          dataToExport = dataToExport.filter(p => p.supervisor === selectedSupervisor);
      }
      const performanceFilter = selectors.performance.value;
      if (performanceFilter) { dataToExport = dataToExport.filter(d => { if (performanceFilter === 'critical') return d.perc < 80; if (performanceFilter === 'good') return d.perc >= 80 && d.perc < 100; if (performanceFilter === 'excellent') return d.perc >= 99.9; return true; }); }
      const searchTerm = (dataType === 'supervisor' ? selectors.searchSupervisor : selectors.searchPreceptor).value.toLowerCase().trim();
      if (searchTerm) { dataToExport = dataToExport.filter(d => d.name.toLowerCase().includes(searchTerm)); }
      return dataToExport;
  }

  selectors.btnExportSupervisores.addEventListener('click', () => exportToCSV(getFilteredExportData('supervisor'), 'supervisores-performance.csv'));
  selectors.btnExportPreceptores.addEventListener('click', () => {
      const data = getFilteredExportData('preceptor');
      const filename = selectedSupervisor ? `preceptores-performance-de-${selectedSupervisor.replace(/\s/g, '_')}.csv` : 'preceptores-performance.csv';
      exportToCSV(data, filename);
  });

  setFiltrosHabilitados(false);
  ui.supervisorTableContainer.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">Carregue um arquivo CSV para iniciar a an√°lise.</p>';
});
</script>
</body>
</html>